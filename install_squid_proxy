---
- name: D√©ploiement Complet du Proxy Squid (Installation, Configuration et S√©curit√©)
  hosts: all
  become: yes

  handlers:
    # Handler appel√© pour red√©marrer Squid si le fichier de configuration a chang√©
    - name: Red√©marrer Squid
      ansible.builtin.service:
        name: squid
        state: restarted

  tasks:
    # --- 1. Installation des Services (Squid et UFW) ---
    - name: üì¶ Installer les paquets Squid et UFW
      ansible.builtin.apt:
        name:
          - squid
          - ufw
        update_cache: yes
        state: present

    # --- 2. Configuration des ACLs (LA CORRECTION : AVANT LE D√âMARRAGE) ---
    - name: ‚öôÔ∏è Copie du fichier de configuration Squid corrig√© avec ACLs
      ansible.builtin.template:
        src: squid.conf.j2
        dest: /etc/squid/squid.conf
        owner: proxy
        group: proxy
        mode: '0644'
      # Notifie le handler pour red√©marrer (si le fichier change)
      notify: Red√©marrer Squid

    # --- 3. D√©marrage du Service (VERIFICATION : UTILISE MAINTENANT LE FICHIER CORRIG√â) ---
    - name: üî• Assurer que le service Squid est d√©marr√© et activ√©
      ansible.builtin.service:
        name: squid
        state: started
        enabled: yes

    # --- 4. Configuration du Pare-feu (UFW) ---
    # Ces t√¢ches peuvent venir apr√®s le d√©marrage du service
    - name: üîì Autoriser le port SSH (22) pour maintenir l'acc√®s
      community.general.ufw:
        rule: allow
        port: '22'
        proto: tcp

    - name: üîì Autoriser le trafic pour Squid (port 3128)
      community.general.ufw:
        rule: allow
        port: '3128'
        proto: tcp

    - name: üî• Activer et s'assurer que UFW est d√©marr√©
      community.general.ufw:
        state: enabled
